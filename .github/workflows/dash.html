<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Gold Investment Tracking Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for professional appearance */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .P-positive { color: #10b981; } /* emerald-500 */
        .P-negative { color: #ef4444; } /* red-500 */
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 border-b-2 border-indigo-500 pb-2">
            Virtual Gold Investment Portfolio Dashboard
        </h1>

        <!-- Data Management Section (Load/Save) -->
        <div class="card bg-white p-6 rounded-xl mb-8 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <h2 class="text-xl font-semibold text-gray-800">Data Management (Local CSV)</h2>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <input type="file" id="csv-input" accept=".csv" class="hidden" />
                <button id="load-csv-button" class="px-4 py-2 text-sm font-medium text-white bg-indigo-500 rounded-md hover:bg-indigo-600 transition shadow-md w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.293 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    Load Transactions (CSV)
                </button>
                <button id="save-csv-button" class="px-4 py-2 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200 transition shadow-md w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 011 1v5.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 011.414-1.414L9 8.586V3a1 1 0 011-1zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                    Save Transactions (CSV)
                </button>
            </div>
            <div id="data-status" class="text-sm text-gray-500 mt-2 sm:mt-0">Dashboard ready. Load a file or add transactions.</div>
        </div>

        <!-- Add New Transaction Form Section -->
        <div class="card bg-white p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Add New Transaction</h2>
            <!-- Updated to md:grid-cols-4 for 4 inputs -->
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                
                <!-- Input: Date -->
                <div>
                    <label for="input-date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="input-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                
                <!-- Input: Type -->
                <div>
                    <label for="input-type" class="block text-sm font-medium text-gray-700">Type</label>
                    <select id="input-type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 bg-white">
                        <option value="Buy">Buy</option>
                        <option value="Sell">Sell</option>
                    </select>
                </div>
                
                <!-- Input: Amount (Spent/Received) -->
                <div>
                    <label for="input-amount" class="block text-sm font-medium text-gray-700">Amount (₹) (Total Paid for Buy / Received from Sell)</label>
                    <input type="number" id="input-amount" step="0.01" value="0.00" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                
                <!-- Input: Weight -->
                <div>
                    <label for="input-weight" class="block text-sm font-medium text-gray-700">Weight (mg)</label>
                    <input type="number" id="input-weight" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                
                <!-- Submit Button -->
                <div class="md:col-span-4 flex justify-end">
                    <button type="submit" class="w-full md:w-auto mt-4 px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        Add Transaction
                    </button>
                </div>
            </form>
        </div>

        <!-- Summary Statistics Section -->
        <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Cards will be injected here -->
        </div>

        <!-- Graph Section -->
        <div class="card bg-white p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Price per mg Variation Over Time</h2>
            <div class="h-96">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <!-- Transaction Table Section -->
        <div class="card bg-white p-6 rounded-xl overflow-x-auto">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Detailed Transaction Log</h2>
            <table id="transaction-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-indigo-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Base Cost (₹)</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Received (₹)</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Tax (₹)</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Weight (mg)</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Balance Weight (mg)</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-indigo-600 uppercase tracking-wider">Price/mg (₹)</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">COGS (₹)</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-green-600 uppercase tracking-wider">P&L (₹)</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="table-body">
                    <!-- Table rows will be injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let rawData = [];
        let priceChart; // Global chart instance

        /**
         * Formats a number as an Indian Rupee currency string.
         * @param {number} amount - The numeric amount.
         * @returns {string} The formatted currency string.
         */
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 2,
            }).format(amount);
        };

        /**
         * Calculates the Cost of Goods Sold (COGS) for a sale using FIFO.
         * It simulates the inventory based on all previous Buy transactions.
         * @param {Array<Object>} data - The existing rawData transactions array.
         * @param {number} saleWeight - The weight being sold in the current transaction.
         * @returns {number} The calculated COGS amount.
         */
        function calculateCogsFIFO(data, saleWeight) {
            let remainingSaleWeight = saleWeight;
            let calculatedCogs = 0;
            
            // 1. Rebuild current inventory state (Buy transactions that still have weight left)
            let tempInventory = [];

            // Simulate all transactions to find the current available inventory and its cost basis (FIFO)
            for (const t of data) {
                if (t.type === 'Buy' && t.weight > 0) {
                    // Cost = Spent (Base Cost) + Tax (Total amount paid for this weight)
                    const totalPaid = t.spent + t.tax;
                    const pricePerMg = totalPaid / t.weight; 
                    
                    tempInventory.push({
                        date: t.date,
                        weight: t.weight,
                        remainingWeight: t.weight, // This will be consumed by subsequent sales
                        costPerMg: pricePerMg
                    });
                } else if (t.type === 'Sell' && t.weight > 0) {
                    // Apply this historical sale against the inventory (FIFO)
                    let consumedWeight = t.weight;
                    for (const item of tempInventory) {
                        if (item.remainingWeight > 0) {
                            const consume = Math.min(consumedWeight, item.remainingWeight);
                            item.remainingWeight -= consume;
                            consumedWeight -= consume;
                            if (consumedWeight <= 0) break;
                        }
                    }
                }
            }
            
            // Filter the final inventory state: only items with remaining weight (FIFO order preserved)
            const inventory = tempInventory.filter(item => item.remainingWeight > 0);
            
            // 2. Calculate COGS for the *new* sale using FIFO on the current inventory
            for (const item of inventory) {
                if (remainingSaleWeight <= 0) break;

                const consume = Math.min(remainingSaleWeight, item.remainingWeight);
                
                // COGS calculation: weight consumed * cost per mg
                calculatedCogs += consume * item.costPerMg;
                
                remainingSaleWeight -= consume;
            }

            return calculatedCogs;
        }


        /**
         * Converts a CSV string into the structured array of transaction objects.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];

            // Headers are expected: Date,Type,Spent,Received,Tax,Weight,COGSBasis
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) continue;

                const transaction = {
                    date: values[0],
                    type: values[1],
                    spent: parseFloat(values[2]) || 0,
                    received: parseFloat(values[3]) || 0,
                    tax: parseFloat(values[4]) || 0,
                    weight: parseFloat(values[5]) || 0,
                    cogsBasis: parseFloat(values[6]) || 0,
                };
                if (isNaN(transaction.weight) || transaction.weight <= 0) continue; 
                data.push(transaction);
            }
            return data;
        }

        /**
         * Converts the current rawData array into a CSV string.
         */
        function serializeToCSV(data) {
            // Spent now represents Base Cost for Buy transactions.
            const headers = ["Date", "Type", "Spent", "Received", "Tax", "Weight", "COGSBasis"];
            let csv = headers.join(',') + '\n';

            data.forEach(t => {
                const row = [
                    t.date,
                    t.type,
                    (t.spent || 0).toFixed(2), // Base Cost (Buy) or 0 (Sell)
                    (t.received || 0).toFixed(2),
                    (t.tax || 0).toFixed(2),
                    (t.weight || 0).toFixed(2),
                    (t.cogsBasis !== undefined ? t.cogsBasis : 0.00).toFixed(2) 
                ].join(',');
                csv += row + '\n';
            });
            return csv;
        }


        /**
         * Processes the raw transaction data to calculate derived metrics (Price/mg, COGS, P&L) and summary statistics.
         * This now RECALCULATES the running balance for consistency.
         */
        function processData(data) {
            let totalInvestment = 0;
            let totalRevenue = 0;
            let totalRealizedPL = 0;
            let finalBalanceWeight = 0;
            let runningBalance = 0; // Initialize running balance

            const processed = data.map((transaction, index) => {
                const isBuy = transaction.type === 'Buy';
                // Total cost is always Base Cost (spent) + Tax
                const totalCost = isBuy ? transaction.spent + transaction.tax : 0;
                // Total value is total paid (for Buy) or received (for Sell)
                const totalValue = isBuy ? totalCost : transaction.received;
                
                // G: Balance Weight (RECALCULATED)
                if (isBuy) {
                    runningBalance += transaction.weight;
                } else if (transaction.type === 'Sell') {
                    runningBalance -= transaction.weight;
                }
                
                // H: Price per mg
                const pricePerMg = transaction.weight > 0 ? totalValue / transaction.weight : 0;

                // I: COGS (Cost of Goods Sold)
                let cogs = 0;
                if (isBuy) {
                    cogs = totalCost;
                    totalInvestment += totalCost;
                } else {
                    // Use the COGS Basis provided (auto-calculated during input or loaded from CSV)
                    cogs = transaction.cogsBasis || 0;
                    totalRevenue += transaction.received;
                }

                // J: Profit/Loss
                let profitLoss = 0;
                if (!isBuy) {
                    profitLoss = transaction.received - cogs;
                    totalRealizedPL += profitLoss;
                }
                
                // Update finalBalanceWeight
                if (index === data.length - 1) {
                    finalBalanceWeight = runningBalance;
                }

                return {
                    ...transaction,
                    balance: runningBalance, // Include recalculated balance
                    pricePerMg: pricePerMg,
                    cogs: cogs,
                    profitLoss: profitLoss
                };
            });

            return { processedData: processed, totalInvestment, totalRevenue, totalRealizedPL, finalBalanceWeight };
        }

        /**
         * Updates the data status message on the UI.
         */
        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('data-status');
            statusEl.textContent = message;
            statusEl.className = isError 
                ? 'text-sm font-semibold text-red-600 mt-2 sm:mt-0' 
                : 'text-sm text-gray-500 mt-2 sm:mt-0';
        }

        /**
         * Renders the summary statistics cards.
         */
        function renderSummaryCards(stats) {
            const cardsContainer = document.getElementById('summary-cards');
            const data = [
                { title: 'Total Investment', value: formatCurrency(stats.totalInvestment), color: 'bg-indigo-600' },
                { title: 'Total Revenue', value: formatCurrency(stats.totalRevenue), color: 'bg-green-600' },
                { title: 'Total Realized P&L (FIFO)', value: formatCurrency(stats.totalRealizedPL), color: stats.totalRealizedPL >= 0 ? 'bg-emerald-500' : 'bg-red-500' },
                { title: 'Current Balance Weight', value: `${stats.finalBalanceWeight.toFixed(2)} mg`, color: 'bg-yellow-500' }
            ];

            cardsContainer.innerHTML = data.map(item => `
                <div class="card p-5 rounded-lg ${item.color} text-white transition duration-300 hover:shadow-xl transform hover:-translate-y-1">
                    <p class="text-sm font-medium opacity-80">${item.title}</p>
                    <p class="text-2xl font-bold mt-1">${item.value}</p>
                </div>
            `).join('');
        }

        /**
         * Renders the transaction table with calculated values.
         */
        function renderTransactionTable(processedData) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = processedData.map(row => {
                const isSell = row.type === 'Sell';
                const rowClass = isSell ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-gray-50';
                const plClass = row.profitLoss >= 0 ? 'P-positive font-semibold' : 'P-negative font-semibold';
                
                return `
                    <tr class="${rowClass} text-gray-700">
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${row.date}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-center">${row.type}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right">${formatCurrency(row.spent)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right">${formatCurrency(row.received)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right">${formatCurrency(row.tax)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right">${row.weight.toFixed(2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right">${row.balance.toFixed(2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right text-indigo-700">${formatCurrency(row.pricePerMg)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right">${formatCurrency(row.cogs)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right ${plClass}">${formatCurrency(row.profitLoss)}</td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Initializes and renders the Chart.js graph.
         */
        function renderPriceChart(processedData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Map data for Chart.js
            const labels = processedData.map(d => d.date);
            const prices = processedData.map(d => d.pricePerMg.toFixed(2));
            const transactionTypes = processedData.map(d => d.type);
            
            // Define points colors based on transaction type
            const pointColors = transactionTypes.map(type => 
                type === 'Buy' ? '#4f46e5' : '#ef4444' // Indigo for Buy, Red for Sell
            );
            
            // Destroy previous chart instance if it exists
            if (priceChart) {
                priceChart.destroy();
            }

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price per mg (₹)',
                        data: prices,
                        borderColor: '#10b981', // Emerald line color
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: pointColors, // Color points differently
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date of Transaction'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price per mg (₹)'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `${context[0].label} (${transactionTypes[context[0].dataIndex]})`;
                                },
                                label: function(context) {
                                    return `Price: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Main function to calculate, render summary, table, and chart.
         */
        function calculateAndRender() {
            if (rawData.length === 0) {
                renderSummaryCards({ totalInvestment: 0, totalRevenue: 0, totalRealizedPL: 0, finalBalanceWeight: 0 });
                renderTransactionTable([]);
                renderPriceChart([]);
                return;
            }
            // Sort data by date before processing to ensure FIFO integrity across all calculations
            // The date format is DD/MM/YYYY, so we convert it to ISO for accurate sorting
            rawData.sort((a, b) => {
                const dateA = a.date.split('/').reverse().join('-');
                const dateB = b.date.split('/').reverse().join('-');
                return new Date(dateA) - new Date(dateB);
            });

            const { processedData, totalInvestment, totalRevenue, totalRealizedPL, finalBalanceWeight } = processData(rawData);
            
            renderSummaryCards({ totalInvestment, totalRevenue, totalRealizedPL, finalBalanceWeight });
            renderTransactionTable(processedData);
            renderPriceChart(processedData);
        }

        /**
         * Handles the form submission for adding a new transaction.
         */
        function handleFormSubmit(event) {
            event.preventDefault();

            const dateInput = document.getElementById('input-date').value;
            const typeInput = document.getElementById('input-type').value;
            const amountInput = parseFloat(document.getElementById('input-amount').value) || 0;
            const weightInput = parseFloat(document.getElementById('input-weight').value) || 0;

            if (weightInput <= 0) {
                updateStatus("Transaction failed: Weight must be greater than zero.", true);
                return;
            }

            let calculatedTax = 0.00;
            let calculatedCogsBasis = 0.00; 
            let spent = 0.00; // Base Cost for Buy, 0 for Sell
            let received = 0.00;

            // Calculate Tax (3% of buying amount)
            if (typeInput === 'Buy') {
                // amountInput is Total Paid (Base Cost + 3% Tax)
                const totalPaid = amountInput;
                const baseCost = totalPaid / 1.03; // Base cost before 3% tax
                calculatedTax = totalPaid - baseCost;
                spent = baseCost; // 'Spent' in the transaction object represents Base Cost
            } else {
                // 'Received' is the amount from selling
                received = amountInput;
            }

            // Check if a sale exceeds current balance (requires a full data process first)
            const { finalBalanceWeight } = processData(rawData);
            if (typeInput === 'Sell') {
                if (weightInput > finalBalanceWeight) {
                    updateStatus(`Transaction failed: Selling ${weightInput.toFixed(2)} mg exceeds current balance of ${finalBalanceWeight.toFixed(2)} mg.`, true);
                    return;
                }
                // Calculate COGS (FIFO) immediately before adding the transaction
                calculatedCogsBasis = calculateCogsFIFO(rawData, weightInput);
            }

            // Construct new transaction object
            const newTransaction = {
                date: new Date(dateInput).toLocaleDateString('en-GB'),
                type: typeInput,
                spent: spent, 
                received: received,
                tax: calculatedTax,
                weight: weightInput,
                cogsBasis: calculatedCogsBasis 
            };

            // Add to the data source
            rawData.push(newTransaction);
            
            // Recalculate and re-render everything
            calculateAndRender();
            updateStatus(`New ${typeInput} transaction added successfully! Total transactions: ${rawData.length}`);

            // Reset form inputs 
            document.getElementById('input-amount').value = '0.00';
            document.getElementById('input-weight').value = '';
        }
        
        /**
         * Event handler for loading a CSV file via file input.
         */
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const loadedData = parseCSV(csvText);
                    if (loadedData.length === 0) {
                        updateStatus("Error: Could not parse CSV or file is empty.", true);
                        rawData = [];
                    } else {
                        rawData = loadedData;
                        calculateAndRender();
                        updateStatus(`Successfully loaded ${rawData.length} transactions from CSV.`);
                    }
                } catch (error) {
                    console.error("File loading error:", error);
                    updateStatus("Error reading or parsing file.", true);
                }
            };
            reader.onerror = () => updateStatus("Failed to read file.", true);
            reader.readAsText(file);
        }

        /**
         * Event handler for triggering the CSV download.
         */
        function handleFileSave() {
            if (rawData.length === 0) {
                updateStatus("No data to save. Add some transactions first.", true);
                return;
            }
            
            const csvContent = serializeToCSV(rawData);
            
            // Create a Blob and initiate download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            const date = new Date().toISOString().split('T')[0];
            link.download = `investment_data_${date}.csv`;
            link.href = URL.createObjectURL(blob);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateStatus(`Successfully saved ${rawData.length} transactions to CSV.`);
        }
        
        /**
         * Loads default data (now empty as requested).
         */
        function loadDefaultDataIfEmpty() {
            rawData = [];
            updateStatus("Dashboard ready. Add transactions or load a file.");
        }


        // Setup event listener and initial rendering
        window.onload = function() {
            // Set today's date as default for the date input
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;

            // Load default data (which is now an empty array)
            loadDefaultDataIfEmpty();
            
            // Setup form listener
            document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
            
            // File I/O setup listeners
            document.getElementById('load-csv-button').addEventListener('click', () => {
                document.getElementById('csv-input').click(); // Triggers the hidden file input
            });
            document.getElementById('csv-input').addEventListener('change', handleFileLoad);
            document.getElementById('save-csv-button').addEventListener('click', handleFileSave);
        };

    </script>
</body>
</html>
